<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>中医穴位</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="{{ static_url('ui/bootstrap/css/bootstrap.min.css') }}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{{ static_url('ui/css/font-awesome.min.css') }}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="{{ static_url('ui/css/ionicons.min.css') }}">
    <!-- Theme style -->
    <link rel="stylesheet" href="{{ static_url('ui/dist/css/AdminLTE.min.css') }}">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="{{ static_url('ui/dist/css/skins/_all-skins.min.css') }}">
    <link rel="stylesheet" href="{{ static_url('layer/css/layui.css') }}" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="{{ static_url('acupuncture/xuewei_kg.css') }}">
</head>
<body class="hold-transition skin-green-light sidebar-mini">
<div class="wrapper">
    <header class="main-header">
        <!-- Logo -->
        <a href="http://www.ict.ac.cn/" class="logo" id="head1">
            <!-- mini logo for sidebar mini 50x50 pixels -->
            <span class="logo-mini">针医堂</span>
            <!-- logo for regular state and mobile devices -->
            <span class="logo-lg"><b> 针 医 堂</b></span>
        </a>

        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top" id="head2">
            <!-- Sidebar toggle button-->
            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </a>

            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <li class="dropdown user user-menu">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <img src="{{ static_url('ui/dist/img/user2-160x160.jpg') }}" class="user-image" alt="User Image">
                            <span class="hidden-xs">{{ current_doctor.get(u'name', u'')}}</span>
                        </a>
                        <ul class="dropdown-menu">
                            <!-- User image -->
                            <li class="user-header">
                                <img src="{{ static_url('ui/dist/img/user2-160x160.jpg') }}" class="img-circle" alt="User Image">
                                <p>
                                    {{ current_doctor.get(u'name', u'')}}
                                    <small>Member since Nov. 2018</small>
                                </p>
                            </li>
                            <!-- Menu Body -->
                            <li class="user-body">
                                <div class="row">
                                    <div class="col-xs-4 text-center">
                                        <a href="#">Followers</a>
                                    </div>
                                    <div class="col-xs-4 text-center">
                                        <a href="#">Sales</a>
                                    </div>
                                    <div class="col-xs-4 text-center">
                                        <a href="/invitation">邀请好友</a>
                                    </div>
                                </div>
                                <!-- /.row -->
                            </li>
                            <!-- Menu Footer-->
                            <li class="user-footer">
                                <div class="pull-left">
                                    <a href="#" class="btn btn-default btn-flat">Profile</a>
                                </div>
                                <div class="pull-right">
                                    <a href="/xuewei/logout" class="btn btn-default btn-flat">Sign out</a>
                                </div>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
            <!-- Sidebar user panel -->
            <div class="user-panel">
                <div class="pull-left image">
                    <img src="{{ static_url('ui/dist/img/user2-160x160.jpg') }}" class="img-circle" alt="User Image">
                </div>
                <div class="pull-left info">
                    <p>{{ current_doctor["name"] }}</p>
                    <a href="#"><i class="fa fa-circle text-success"></i> 在线</a>
                </div>
            </div>
            <!-- search form -->
            <div class="sidebar-form">
                <div class="input-group">
                    <input type="text" name="q" class="form-control" id="search_graph_name" placeholder="搜索疾病知识图谱...">
                    <span class="input-group-btn">
                            <button type="submit" name="search" id="search-btn" class="btn btn-flat"
                                    onclick="search_knowledge_graph()"><i class="fa fa-search"></i>
                            </button>
                        </span>
                </div>
            </div>
            <!-- /.search form -->
            <div class="side" file="side.html"></div>

            <!-- sidebar menu: : style can be found in sidebar.less -->
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                中医穴位
                <small>穴位，学名腧穴，指人体经络线上特殊的点区部位，中医可以通过针灸或者推拿、点按、艾灸刺激相应的经络点治疗疾病。</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="/xuewei/case_index"><i class="fa fa-dashboard"></i> 首页</a></li>

                <li class="active">中医穴位推荐</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">
            <!-- COLOR PALETTE -->
            <div class="layui-tab layui-tab-card box" style="min-height: 700px;">
                {% for index,(cate,dis_dict) in enumerate(disease.items()) %}
                <ul class="layui-tab-title">
                    {% if index == 0 %}
                    <li class="layui-this" style="font-size:18px;"><i class="fa fa-commenting text-blue"></i> {{ cate }}</li>
                    {% else %}
                    <li style="font-size:18px;"><i class="fa fa-signal" aria-hidden="true"></i> {{ cate }}</li>
                    {% end %}
                </ul>
                <div class="layui-tab-content" style="min-height: 690px;overflow:auto">
                    <div class="layui-tab-item layui-show">
                        <div class="box box-info direct-chat direct-chat-info">
                            <div>
                                <ul class="timeline timeline-inverse">
                                    <li class="time-label">
                                        <span class="bg-red">
                                          穴位推荐
                                        </span>
                                    </li>
                                    <li>
                                        <i class="fa fa-comments bg-yellow"></i>

                                        <div class="timeline-item">
                                            <!--<span class="time"><i class="fa fa-clock-o"></i> 12:05</span>-->

                                            <h3 class="timeline-header"><a href="#">单穴推荐</a></h3>

                                            <div class="timeline-body">

                                            </div>
                                            <div class="timeline-footer" id="dx_recommend">

                                            </div>
                                        </div>
                                    </li>
                                    <!-- END timeline item -->
                                    <!-- timeline item -->
                                    <li>
                                        <i class="fa fa-comments bg-yellow"></i>

                                        <div class="timeline-item">
                                            <!--<span class="time"><i class="fa fa-clock-o"></i> 5 mins ago</span>-->

                                            <h3 class="timeline-header"><a href="#">配穴推荐</a>
                                            </h3>
                                            <div class="timeline-body">

                                            </div>
                                            <div class="timeline-footer" id="px_recommend">

                                                <!--<a class="btn btn-warning btn-flat btn-xs">Update</a>-->
                                            </div>

                                        </div>
                                    </li>
                                    <!-- END timeline item -->
                                    <!-- timeline item -->
                                    <li>
                                        <i class="fa fa-comments bg-yellow"></i>

                                        <div class="timeline-item">
                                            <!--<span class="time"><i class="fa fa-clock-o"></i> 27 mins ago</span>-->

                                            <h3 class="timeline-header"><a href="#">总体推荐</a></h3>

                                            <div class="timeline-body">

                                            </div>
                                            <div class="timeline-footer" id="zt_recommend">
                                                <!--<a class="btn btn-warning btn-flat btn-xs">Update</a>-->
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
                {% end %}
            </div>
            <!-- /.box -->
        </section>
    </div>
    <!-- /.content-wrapper -->
    <div class="footer"></div>

    <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.3 -->
<script src="{{ static_url('ui/plugins/jQuery/jquery-2.2.3.min.js') }}"></script>
<!-- Bootstrap 3.3.6 -->
<script src="{{ static_url('ui/bootstrap/js/bootstrap.min.js') }}"></script>
<!-- FastClick -->
<script src="{{ static_url('ui/plugins/fastclick/fastclick.js') }}"></script>
<!-- AdminLTE App -->
<script src="{{ static_url('ui/dist/js/app.min.js') }}"></script>
<!-- AdminLTE for demo purposes -->
<script src="{{ static_url('ui/dist/js/demo.js') }}"></script>
<script src="{{static_url('d3/d3.v3.min.js')}}"></script>
<script src="{{ static_url('layer/layer.js') }}"></script>
<script src="{{ static_url('layer/layui.js') }}" charset="utf-8"></script>
<script src="{{ static_url('js/echarts.min.js') }}"></script>

<!--<script src="{{ static_url('acupuncture/xuewei_kg.js') }}"></script>-->
<script>
    var level_radius = new Array();
    level_radius["level0"] = 40;
    level_radius["level1"] = 36;
    level_radius["level2"] = 32;
    level_radius["level3"] = 28;
    level_radius["level4"] = 24;
    level_radius["level5"] = 20;
    level_radius["level6"] = 16;
    level_radius["level7"] = 12;
    level_radius["level8"] = 8;
    level_radius["level9"] = 4;
    level_radius["level10"] = 2;

    var marker_radius = new Array();
    marker_radius["level0"] = 34;
    marker_radius["level1"] = 29;
    marker_radius["level2"] = 25;
    marker_radius["level3"] = 20;
    marker_radius["level4"] = 18;
    marker_radius["level5"] = 20;
    marker_radius["level6"] = 16;
    marker_radius["level7"] = 12;
    marker_radius["level8"] = 8;
    marker_radius["level9"] = 4;
    marker_radius["level10"] = 2;
    $(function(){
        $('.side').load('/xuewei/side');
        $('.footer').load('/xuewei/footer');

    });
    $(document).ready(function () {

        //点选按钮start：
        var hz_zz = ["落枕", "闭经", "膝痹", "耳聋", "牙痛", "胸痹", "腕管综合征", "月经不调"];
        var zz_str = '';
        for (var zz_item of hz_zz) {
            zz_str += '<a class="btn btn-primary btn-xs" style="margin:10px;font-size:16px" onclick="select_zz(\'' + zz_item + '\')">' + zz_item + '</a>';
        }
        $('#select_hz').html(zz_str);
        var xxglplp_arr=["综合选穴谱","主症选主穴","辨证选配穴","随症加减穴","擅用效验穴"];
        var xxglplp_str='';
        for (var xxglplp_item of xxglplp_arr) {
            //xxglplp_str += '<a class="btn btn-success btn-xs" style="margin:10px;font-size:16px" onclick="select_xxglplp(\'' + xxglplp_item + '\')">' + xxglplp_item + '</a>';
            xxglplp_str += '<a class="btn btn-success btn-xs" style="margin:10px;font-size:16px">' + xxglplp_item + '</a>';
        }
        $('#xxglplp').html(xxglplp_str);
        //======end：
        var btns = $("#xxglplp a");
        console.log(btns.length);
        for(var i=0;i<btns.length;i++){
            btns[i].index = i;
            btns[i].onclick = function(){
                console.log(this.text);
                for(var j=0;j<btns.length;j++)
                {
                    btns[j].className = "btn btn-success btn-xs";
                }
                this.className = "btn btn-warning btn-xs";
                var xxglplp_content_str='';
                var zhxxp_content_arr=['主穴','配穴','加减穴','效验穴'];
                var zzxzx_content_arr=['古代文献','现代期刊','现代著作','问卷调查'];
                if(this.text=="综合选穴谱"){
                    xxglplp_content_str+='<ul class="timeline timeline-inverse" style="margin-left:10px;font-size:12px">'
                                                +'<li class="time-label"></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 主穴\')"><a href="#" style="font-size:15px">主穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="zx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 配穴\')"><a href="#" style="font-size:15px">配穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="px_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 加减穴\')"><a href="#" style="font-size:15px">加减穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="jjx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 效验穴\')"><a href="#" style="font-size:15px">效验穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="xyx_content"></div></div></li>'
                                            +'</ul>';
                }else if(this.text=="主症选主穴"){
                    xxglplp_content_str+='<ul class="timeline timeline-inverse" style="margin-left:10px;font-size:12px">'
                                                +'<li class="time-label"></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 古代文献\')"><a href="#" style="font-size:15px">古代文献</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="zx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 现代期刊\')"><a href="#" style="font-size:15px">现代期刊</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="px_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 现代著作\')"><a href="#" style="font-size:15px">现代著作</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="jjx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 问卷调查\')"><a href="#" style="font-size:15px">问卷调查</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="xyx_content"></div></div></li>'
                                            +'</ul>';
                }else if(this.text=="辨证选配穴"){
                    xxglplp_content_str += '<ul class="timeline timeline-inverse" style="margin-left:10px;font-size:12px">'
                                                +'<li class="time-label"><span class="bg-red">证型1</span></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型1 古代文献\')"><a href="#" style="font-size:15px">古代文献</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="zx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型1 现代期刊\')"><a href="#" style="font-size:15px">现代期刊</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="px_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型1 现代著作\')"><a href="#" style="font-size:15px">现代著作</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="jjx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型1 问卷调查\')"><a href="#" style="font-size:15px">问卷调查</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="xyx_content"></div></div></li>'
                                                +'<li class="time-label"><span class="bg-red">证型2</span></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型2 古代文献\'><a href="#" style="font-size:15px">古代文献</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="zx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型2 现代期刊\'><a href="#" style="font-size:15px">现代期刊</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="px_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型2 现代著作\'><a href="#" style="font-size:15px">现代著作</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="jjx_content"></div></div></li>'
                                                +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\''+ this.text +' 证型2 问卷调查\'><a href="#" style="font-size:15px">问卷调查</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="xyx_content"></div></div></li>'
                                            +'</ul>';
                }else{
                    xxglplp_content_str += '<span>内容待补充！</span>';
                }
                $('#xxglplp_content').html(xxglplp_content_str);
            }
        }
        var urls = new Array();
        var ids = new Array();
        var marks = new Array();
        var kgtypes = new Array();
        var kg_no = 0;
        urls[kg_no] = "/xuewei/symptom_xuewei_union_graph";kgtypes[kg_no]=kg_no+1;
        ids[kg_no]="kgs";

        kg_no++;
        urls[kg_no] = "/xuewei/symptom_xuewei_union_graph";kgtypes[kg_no]=kg_no+1;
        ids[kg_no]="count_kg";

        kg_no++;
        urls[kg_no] = "/xuewei/symptom_xuewei_union_graph";kgtypes[kg_no]=kg_no+1;
        ids[kg_no]="channel_std_kg";

        kg_no++;
        urls[kg_no] = "/xuewei/symptom_xuewei_union_graph";kgtypes[kg_no]=kg_no+1;
        ids[kg_no]="channel_kg";
        for (var i = 0;i<urls.length;i++){
            $.ajax({
                type: "post",
                async: false,
                url: urls[i],
                data: {"page": 1, "kg_type": kgtypes[i]},
                dataType: "json",
                timeout: 1000,
                success: function (datas) {
                    add_kg(datas, ids[i], "center");
//                    var graph_data = datas["graph"];
//                    var pages = datas["pages"];
//                    add_kg(graph_data, ids[i], "center", marks[i]);
//                    if (pages>1){
//                        pagination(ids[i]+"_pages",ids[i],pages,"/xuewei/symptom_xuewei_union_graph?kg_type="+kgtypes[i],ids[i]);
//                    }
                },
                error: function (datas) {
                    layer.alert("初始化数据失败！");
                }
            });
        }
    pagination("kgs_pages","kgs",17,"/xuewei/symptom_xuewei_union_graph?kg_type=1","kgs");
    });

    function add_kg(graph, id, style) {
        var kg_id = id
        var w = 800, h = 600;
        var linkDistance = 180;
        var text_font_size = 15;
        var class_name;
        if (style === "left") class_name = "left";
        else if (style === "right") class_name = "right";
        else if (style === "center") class_name = "center";
        var force = d3.layout.force()
            .nodes(d3.values(graph[1]["nodes"]))
            .links(d3.values(graph[1]["edges"]))
            .size([w, h])
            .linkDistance(linkDistance)
            .charge(-700)
            .on("tick", tick)
            .start();

        //定义缩放函数
        var zoom = d3.behavior.zoom()
            .scaleExtent([1, 10])
            .on("zoom", zoomed);

        //定义拖拽
        var drag = d3.behavior.drag()
            .origin(function (d) {
                return d;
            })
            .on("dragstart", dragstarted)
            .on("drag", dragged)
            .on("dragend", dragended);

        //定义画布信息
        var svg = d3.select("#"+id).append("svg:svg")
            .attr("width",w)
            .attr("height",h)
            .attr("viewBox", "0,0,600,800")
            .attr("class", class_name)
            .attr("id", id+"_svg")
            .call(zoom)
            .on('dblclick.zoom', function (d) {
                var kgname = graph[0];
                console.log('dblclick');
                layer.open({
                    type: 2,
                    title: kgname,
                    closeBtn: 1,
                    shadeClose: false,
                    shade: 0.3,
                    maxmin: true,
                    area: ['95%', '95%'],
                    anim: 2,
                    content: '/xuewei/knowledge_zoom?disease_name=' + kgname + "&&kg_id=" + kg_id,
                    end: function () {
                    }
                });
            });

        //(2)创建一个cintainer，用于保存zoom的结果，用于控制界面
        var container = svg.append("svg:g");
        //(1)创建箭头
        container.append("svg:defs").selectAll("marker")
            .data(function () {
                var marker_array = [];
                for (var index in marker_radius) {
                    marker_array.push(index + "_" + kg_id);
                }
                return marker_array;
            })
            .enter().append("svg:marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", function (d) {
                var level = d.split("_")[0];
                if (marker_radius.hasOwnProperty(level)) {
                    return marker_radius[level];
                } else {
                    return 15;
                }
            })
            .attr("refY", -1.5)
            .attr("markerWidth", 10)
            .attr("markerHeight", 10)
            .attr("orient", "auto")
            .append("svg:path")
        .attr("d", "M2,-5L10,0L0,5")
        ;

        //(2)根据连线类型引用上面创建的标记
        var path = container.append("g").selectAll("path")
            .data(force.links())
            .enter().append("svg:path")
            .attr("id", function (d, i) {
                return id + "path" + i;
            })
            .attr("class", function (d) {
                if (d.visted === "1")
                    return "link visted";
                return "link " + d.level;
            })
            .attr("marker-end", function (d) {
                if (d.direction == 1)
                    return "url(#" + d.target.level + "_" + kg_id + ")";
            })
            .style("stroke-width", function (d, i) {// 设置线的宽度
                 if (d.source.type == "other")
                    return 2;
                else return d.count / 10+1;
            });
        var edges_text = container.append("g").selectAll(".edgelabel")
            .data(force.links())
            .enter()
            .append("text")
            .style("pointer-events", "none")
            .attr({
                'class': 'edgelabel',
                "fill": "#ff391c",
                'id': function (d, i) {
                    return id + "path" + i;
                },
                'dx': 50,
                'dy': 0
            });
        //设置线条上的文字
        edges_text.append('textPath')
            .attr('xlink:href', function (d, i) {
                return '#' + id + "path" + i
            })
            .style("pointer-events", "none")
            .text(function (d) {

                if (d.source.type == "other")
                    return "";
                else return d.name;
            });

        var circle = container.append("g").selectAll("circle")
            .data(force.nodes())
            .enter().append("svg:circle")
            .attr("r", function (d) {
                if (level_radius.hasOwnProperty(d.level)) {
                    return level_radius[d.level];
                } else {
                    return 12;
                }
            })
            .attr("class", function (d) {
                if (d.times > 1 && (d.type == "xuewei" || d.type == "xuewei2"))
                    return "node visited";
                else
                    return "node " + d.level;
            })
            .on("click", function (d, i) {
                if (d.type === "symptom") {
                    var content = "症状：" + d.name + "</br>";
                    layer.msg(content, {offest: ['1200px', '120px'], icon: 1});
                } else if (d.type === "xuewei" || d.type === "xuewei2") {
                    var content = "穴位：" + d.name + "</br>" +
                        "内容：" + d.content + "</br>" +
                        "频次：" + d.count + "</br>" +
                        "百分比" + d.percentage;
                    layer.msg(content, {offest: ['1200px', '120px'], icon: 1});
                } else {
                    var content =
                        "节点名称: " + d.name + "</br>"
                        + "节点类型：" + d.type + "</br>"
                        + "节点内容：" + d.content;
                    layer.msg(content, {offest: ['1200px', '120px'], icon: 1});
                }
            })
            .on("mouseover", function (d, i) {
                //显示连接线上的文字
                text.style("fill-opacity", function (edge) {
                    if (edge.source === d || edge.target === d) {
                        return 1.0;
                    }
                });
            })
            .on("mouseout", function (d, i) {
                //隐去连接线上的文字
                text.style("fill-opacity", function (edge) {
                    if (edge.source === d || edge.target === d) {
                        return 0.0;
                    }
                });
            })
            .call(drag);

        //首先生长text，绑定nodes节点
        var text = container.append("g").selectAll("text")
            .data(force.nodes())
            .enter().append("svg:text")
            {#            .attr("x", text_font_size)#}
            {#            .attr("y", ".31em")#}
            .attr("class", function (d) {
                if (d.visted === "1")
                    return "node visted";
                return "node " + d.type;
            })
            .attr("id", function (d, i) {
//                if (d.type === "disease" || d.type === "level0") {
//                    return id + "disease";
//                }
                return id + i;
            })
            .attr('dy', '.3em') // 偏移量  
            .attr('text-anchor', 'middle') // 节点名称放在圆圈中间位置 
            .style('font-size', "20px")
            .text(function (d) {
                return d.name;
            });

        //放大函数
        function zoomed() {
            container.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }

        function tick() {
//            nodes.forEach(function (d, i) {
//                d.x = d.x - 10 < 0 ? 10 : d.x;
//                d.x = d.x + 10 > w ? w - 10 : d.x;
//                d.y = d.y - 10 < 0 ? 10 : d.y;
//                d.y = d.y + 10 > h ? h - 10 : d.y;
//            });
            path.attr("d", function (d) {
                var dx = d.target.x - d.source.x,//增量
                    dy = d.target.y - d.source.y,
                    dr = Math.sqrt(dx * dx + dy * dy);
                return "M" + d.source.x + ","
                    + d.source.y + "A" + dr + ","
                    + dr + " 0 0,1 " + d.target.x + ","
                    + d.target.y;
            });
            circle.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
            text.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            });

            edges_text.attr('transform', function (d, i) {
                if (d.target.x < d.source.x) {
                    bbox = this.getBBox();
                    rx = bbox.x + bbox.width / 2;
                    ry = bbox.y + bbox.height / 2;
                    return 'rotate(180 ' + rx + ' ' + ry + ')';
                }
                else {
                    return 'rotate(0)';
                }
            });
        }

        function dragstarted(d) {
            d3.event.sourceEvent.stopPropagation();
            d3.select(this).classed("dragging", true);
            force.start();
        }

        function dragged(d) {
            d3.select(this).attr("x", d.x = d3.event.x).attr("y", d.y = d3.event.y);
        }

        function dragended(d) {
            d3.select(this).classed("dragging", false);
        }
    }

    function search_graph(id_name) {
//        kgs_search,胃脘痛（著作类）
        var graph_name = $("#" + id_name+"_search").val();
        var url = "/xuewei/search_graph";
        $.ajax({
            type: "post",
            async: false,
            url: url,
            data: {"graph_name": graph_name, "kg_id": id_name},
            dataType: "json",
            timeout: 1000,
            success: function (datas) {

                if (datas[0] == 1) {
                    if (id_name == "kgs") {
                        $('#kgs').html("");
                        add_kg(datas[1],"kgs","center","kgs");
                    }

                } else {
                    layer.alert("对不起，系统目前没有收录您输入的疾病的知识图谱！");
                }
            },
            error: function (datas) {
                layer.alert("对不起，系统目前没有收录您输入的疾病的知识图谱！");
            }
        });

    }

    layui.use(['layer', 'laypage', 'element'], function () {
        var layer = layui.layer, laypage = layui.laypage, element = layui.element();
    });

    function  pagination(pages_id,kg_id,pages,url){
        layui.use('laypage', function () {
            var laypage = layui.laypage;
            laypage({
                cont:pages_id   //分页容器的id
                , pages: pages //总页数
                , skin: '#5FB878' //自定义选中色值
                , skip: true //开启跳页
                , groups: 3 //连续显示分页数
                , jump: function (obj, first) {
                    var page = obj.curr;
                    $.ajax({
                        type: "post",
                        async: false,
                        url: url,
                        data: {"page": page},
                        dataType: "json",
                        timeout: 1000,
                        success: function (datas) {
                            var all_graph = datas;
                            $('#'+kg_id).html("");
                            add_kg(datas, kg_id,"center");
                        },
                        error: function (datas) {
                            layer.alert("初始化数据失败！");
                        }
                    });
                }
            });
        });
    }
</script>

<script>
    function sk(){
        var peiwu_content=document.getElementById('peiwu_tables').innerHTML ;
        console.log(peiwu_content);
        layer.open({
            type: 1,
            area: ['80%', '360px'],
            shade: [0.8, '#393D49'],
            title: false,
            content:peiwu_content,
        });
    }
    function start_recommend() {
        var symptoms = $("#symptoms").val();
        if (symptoms == "" || symptoms == undefined)
            return;
        var user_info = {"symptoms": symptoms};
        {#          var json_str = $.toJSON(user_info);#}

        var url = "/xuewei/recommend_xuewei";
        if (symptoms != "") {
            $.ajax({
                type: "post",
                async: false,
                url: url,
                data: user_info,
                dataType: "json",
                timeout: 1000,
                success: function (datas) {
                    console.log(datas);
                    if (datas["success"] == 0) {
                        $("#dx_recommend").text("抱歉，没有相关推荐");
                        $("#px_recommend").text("抱歉，没有相关推荐");
                        $("#zt_recommend").text("抱歉，没有相关推荐");
                    }
                    else {
                        $("#dx_recommend").text(datas["data"]["danxue"]);
                        $("#px_recommend").text(datas["data"]["peixue"]);
                        $("#zt_recommend").text(datas["data"]["xuewei"]);
                    }

                    {#					  $("#user_info").html(datas["user_info"]);#}
                    {#                      addHtmlRes(datas);#}
                },
                error: function (res) {
                    {#                      alert("请求错误！");#}
                }
            });
        }
    }
    function select_zz(item) {
        console.log(item);
        var item_str = '';
        var symptoms_item = $("#symptoms").val();
        //item_str+=symptoms_item+','+item;
        if (symptoms_item == '') {
            item_str += item ;
            $("#symptoms").val(item_str);
        }
        else {
            item_str += symptoms_item + ',' + item;
            $("#symptoms").val(item_str);
        }
    }
    /* function select_xxglplp(items){
        console.log(items);
        var xxglplp_content_str='';

        xxglplp_content_str+='<ul class="timeline timeline-inverse" style="margin-left:10px;font-size:12px">'
                                        +'<li class="time-label"><span class="bg-red">'
                                        + items
                                        +'</span></li>'
                                        +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header" onclick="contentLayer(\'' + items + '\')"><a href="#" style="font-size:15px">主穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="zx_content"></div></div></li>'
                                        +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header"><a href="#" style="font-size:15px">配穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="px_content"></div></div></li>'
                                        +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header"><a href="#" style="font-size:15px">加减穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="jjx_content"></div></div></li>'
                                        +'<li><i class="fa fa-comments bg-yellow"></i><div class="timeline-item"><h3 class="timeline-header"><a href="#" style="font-size:15px">效验穴</a></h3><div class="timeline-body"></div><div class="timeline-footer" id="xyx_content"></div></div></li>'
                                    +'</ul>';
        $('#xxglplp_content').html(xxglplp_content_str);
    } */
    function contentLayer(itemcontent){
        layer.open({
            type: 2,
            title: itemcontent,
            closeBtn: 1,
            shadeClose: false,
            shade: 0.3,
            maxmin: true,
            area: ['88%', '88%'],
            anim: 2,
            content: '/xuewei/frequency?itemcontent='+itemcontent,
            end: function () {
            }
        });
    }
</script>
<script>
    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var seperator2 = ":";
        var month = date.getMonth() + 1;
        var weekday = new Array(7);
        weekday[0] = "星期天";
        weekday[1] = "星期一";
        weekday[2] = "星期二";
        weekday[3] = "星期三";
        weekday[4] = "星期四";
        weekday[5] = "星期五";
        weekday[6] = "星期六";

        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + weekday[date.getDay()] + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();

        document.getElementById('test').innerText = currentdate;
        setTimeout("getNowFormatDate()", 1000);
    }
    function sendMessage() {
        var user_ques = $("#questionText").val();
        if (user_ques.length > 0) {
            $('<div class="direct-chat-msg right">' +
                '<div class="direct-chat-info clearfix">' +
                '<span class="direct-chat-name pull-right">患者</span>' +
                '<span class="direct-chat-timestamp pull-left">23 China 2:05 pm</span>' +
                '</div>' +
                '<img class="direct-chat-img" src="{{ static_url('ui/dist/img/child-boy1.png') }}" alt="message user image">' +
                '<div class="direct-chat-text" style="border-color:green;background-color:#FFFFBB;color:black;text-align:right;width:auto;margin-left:50px">' +
                '<h4>' + user_ques + '</h4>' +
                '</div>' +
                '</div>').appendTo("#chat-box");
            $("#chat-box").animate({"scrollTop": $('#chat-box')[0].scrollHeight}, "slow");
            var url = "/doctor_wenda";
            $.ajax({
                type: "post",
                async: false,
                url: url,
                data: {user_ques: user_ques},
                dataType: "json",
                timeout: 1000,
                success: function (datas) {
                    var sys = '<div class="direct-chat-msg">' +
                        '<div class="direct-chat-info clearfix">' +
                        '<span class="direct-chat-name pull-left">医生</span>' +
                        '<span class="direct-chat-timestamp pull-right">23 China 2:05 pm</span>' +
                        '</div>' +
                        '<img class="direct-chat-img" src="{{ static_url('ui/dist/img/user1-128x128.jpg') }}" alt="message user image">' +
                        '<div class="direct-chat-text" style="background-color:#d2e9ff;width:auto;margin-right:50px">';
                    if (datas["is_stop"] == true) {
                        sys += '<h4>' + '您的诊断结果为:' + datas["res"] + '</h4>' + '<br>' + '<h5>' + '解释：' + datas["reason"] + '</h5>' +
                            '</div>' + '</div>';
                        $(sys).appendTo("#chat-box");
                        $("#chat-box").animate({"scrollTop": $('#chat-box')[0].scrollHeight}, "slow");
                    } else {
                        sys += '<h4> 您是否还有以下症状：' + '</h4>' + '<br>' + '<div>';
                        var other_symps = datas["res"].split("，");
                        var dingyi = datas["zzdy"];
                        for (var i = 0; i < other_symps.length; i++) {
                            sys += '<button name="" type="button" class="btn btn-info" ' +
                                'id = "symp' + (datas["count"] * 137 + (i + 1)) + '"' +
                                ' onclick="getSymp(' + (datas["count"] * 137 + (i + 1)) + ')"' +
                                ' ondblclick="deleteSymp(' + (datas["count"] * 137 + (i + 1)) + ')"' +
                                ' style="margin:5px;background-color:#2894ff">' +
                                other_symps[i] + '</button>';
                            sys += ' <label id="label' + (datas["count"] * 137 + (i + 1)) + '"' + ' style="display: none;">';
                            if (dingyi.hasOwnProperty(other_symps[i])) {
                                sys += dingyi[other_symps[i]];
                            } else {
                                sys += '待补充';
                            }
                            sys += '</label>';
                        }
                        sys += '<button name="" type="button" class="btn btn-info" ' +
                            'id = "symp' + 123456789 + '"' +
                            ' onclick="getSymp(' + 123456789 + ')"' +
                            ' ondblclick="deleteSymp(' + 123456789 + ')"' +
                            ' style="margin:5px;background-color:#ff6666">' +
                            '已无其他症状' + '</button>';
                        sys += '</div>' + '</div>' + '</div>';
                        $(sys).appendTo("#chat-box");
                        $("#chat-box").animate({"scrollTop": $('#chat-box')[0].scrollHeight}, "slow");
                    }
                },
                error: function (datas) {
                }
            });
        }
    }
    function getSymp(index) {
        var id = "#symp" + index;
        var symp = $(id).text().trim();
        var last_text = $("#questionText").val();

        last_text.replace("，", ",");
        last_text.replace("；", ",");
        last_text.replace(" ", ",");

        var symp_arr = last_text.split(",");

        if (symp_arr.indexOf(symp) == -1) {
            var newValue = last_text + (last_text == "" ? "" : ",") + symp;
            $("#questionText").val(newValue);//填充内容
        }
        $(id).css("background", "#008888");
        getTermTip(index);
    }
    function sleep(n) {
        var start = new Date().getTime();
        while (true) {
            if (new Date().getTime() - start > n) break;
        }
    }
    function getTermTip(index) {
        var btn_id = "#symp" + index;
        var label_id = "#label" + index;
        var show_text = $(label_id).text();

        layer.tips(show_text, btn_id, {
            tips: [1, "#5bc0de"],
            time: 3000
        });

    }
    function deleteSymp(index) {
        var btn_id = "#symp" + index;
        var symp = $(btn_id).text().trim();
        var last_text = $("#questionText").val();
        last_text.replace("，", ",");
        last_text.replace("；", ",");
        last_text.replace(" ", ",");
        var symp_arr = last_text.split(",");
        var new_text = "";
        for (var i = 0; i < symp_arr.length; i++) {
            if (symp_arr[i] != symp) {
                new_text += symp_arr[i] + ",";
            }
        }
        new_text = new_text.substring(0, new_text.length - 1);
        $("#questionText").val(new_text);
        $(btn_id).css("background", "#2894ff");
    }
</script>
</body>
</html>
